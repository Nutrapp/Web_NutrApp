<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes: <%= produto.nome_gen %> - RotuScan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/viewProduto.css">
    <link rel="stylesheet" href="/css/produtos.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>

<body>
    <%-include('./partials/navbar.ejs')%>

    <div class="container mt-5 pt-5">
        <div class="product-detail-card">
            <div class="row g-4">
                <!-- Coluna da imagem -->
                <div class="col-md-5 product-image-col text-center">
                    <img src="<%= produto.url_imagem_produto ? produto.url_imagem_produto : '/img/placeholder.jpg' %>"
                        alt="Imagem de <%= produto.nome_gen %>"
                        onerror="this.onerror=null;this.src='/img/placeholder.jpg';">
                </div>

                <!-- Coluna de informações -->
                <div class="col-md-7 product-info-col">
                    <p class="small text-muted mb-3">
                        Cadastrado por:
                        <span class="fw-bold">
                            <%= nomeCadastrador %>
                        </span>
                    </p>

                    <!-- Código de barras -->
                    <div>
                        <span class="info-label">Código de Barras:</span>
                        <p class="info-value" id="cod-barra-valor" data-cod-barra="<%= produto.cod_barra %>">
                            <%= produto.cod_barra %>
                        </p>
                        <div class="barcode-container">
                            <svg id="barcode"></svg>
                        </div>
                    </div>

                    <!-- Nome genérico -->
                    <div>
                        <span class="info-label">Nome Genérico:</span>
                        <p class="info-value"><%= produto.nome_gen %></p>
                    </div>

                    <!-- Quantidade -->
                    <div>
                        <span class="info-label">Quantidade:</span>
                        <p class="info-value"><%= produto.quantidade %>g</p>
                    </div>

                    <!-- Marca -->
                    <div>
                        <span class="info-label">Marca:</span>
                        <p class="info-value"><%= produto.marca_produto %></p>
                    </div>

                    <!-- Ingredientes -->
                    <% if (produto.ingredientes && produto.ingredientes.length) { %>
                    <div class="mt-3">
                        <span class="info-label">Ingredientes:</span>
                        <div class="d-flex flex-wrap mt-1">
                            <% produto.ingredientes.forEach(function(ing){ %>
                                <span class="badge bg-light text-dark me-1 mb-1" title="<%= ing.descricao || '' %>">
                                    <i class="fas fa-seedling"></i> <%= ing.nome %>
                                </span>
                            <% }) %>
                        </div>
                    </div>
                    <% } %>

                    <!-- Aviso de consumo -->
                    <% 
                        let aviso = "Não foi possível determinar se pode consumir este produto.";
                        if (produto.ingredientes && produto.ingredientes.length) {
                            const alergicos = ['glúten','leite','amendoim','soja','ovos','peixe','crustáceos','nozes','trigo','cevada','aveia'];
                            const contem = produto.ingredientes.some(ing => alergicos.includes(ing.nome.toLowerCase()));
                            aviso = contem ? "Contém alergênicos, atenção!" : "Pode consumir sem restrições.";
                        }
                    %>
                    <div class="mt-2">
                        <small class="allergy-warning text-danger fw-bold">
                            <i class="fas fa-exclamation-triangle"></i> <%= aviso %>
                        </small>
                    </div>

                    <!-- Botões -->
                    <div class="mt-4 d-flex justify-content-end gap-2">
                        <a href="/produtos" class="btn btn-secondary">Voltar para Lista</a>

                        <% const isOwner=typeof usuarioLogado !=='undefined' && usuarioLogado &&
                            usuarioLogado.id && produto.usuario_id_fk &&
                            String(usuarioLogado.id)===String(produto.usuario_id_fk); %>
                        <% if (isOwner) { %>
                            <a href="/produto/edit/<%= produto.id %>" class="btn btn-edit-custom">
                                <i class="fas fa-edit"></i> Editar
                            </a>
                            <form action="/produtos/delete/<%= produto.id %>" method="POST"
                                onsubmit="return confirm('ATENÇÃO: Você tem certeza que deseja excluir este produto? Essa ação é irreversível.')"
                                style="display: inline;">
                                <button type="submit" class="btn btn-delete-custom">
                                    <i class="fas fa-trash"></i> Excluir
                                </button>
                            </form>
                        <% } %>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="/js/script.js"></script>
    <script src="/js/editProduto.js"></script>
</body>

</html>
